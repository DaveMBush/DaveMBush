{
    "version": "https://jsonfeed.org/version/1",
    "title": "Dave's Notebook • All posts by \"file upload\" tag",
    "description": null,
    "home_page_url": "http://davembush.github.com",
    "items": [
        {
            "id": "http://davembush.github.com/upload-an-image-as-a-file-in-angular/",
            "url": "http://davembush.github.com/upload-an-image-as-a-file-in-angular/",
            "title": "Upload an Image as a File in Angular",
            "date_published": "2017-07-04T10:30:08.000Z",
            "content_html": "<p>This past week, I needed to be able to upload an image in my application to the server as a file so that I could crop it and upload it. </p>\n<p>Now, uploading an image that you pulled up using the file upload control is relatively straight forward.  But, in our case, the image we want to be able to upload didn’t always come from the user’s file system.  This causes two problems. </p>\n<p>First, you can’t crop an image you retrieved from a different URL using the HTML Canvas because of Cross Origin restrictions and second, you can’t upload the file using the standard file upload mechanism because you didn’t get it from the file system. <figure><img src=\"/uploads/2017/07/2017-07-04.jpg\" title=\"Upload an Image as a File in Angular\"> Photo via <a href=\"//visualhunt.com/re/3bc74d\">Visual Hunt</a></figure></p>\n<span id=\"more\"></span>\n\n<h2 id=\"Image-to-Data-without-Canvas\"><a href=\"#Image-to-Data-without-Canvas\" class=\"headerlink\" title=\"Image to Data without Canvas\"></a>Image to Data without Canvas</h2><p>Now, the standard way of converting an Image to a data URL is to</p>\n<ul>\n<li>create a new Image,</li>\n<li>set the onload event handler to a function</li>\n<li>set the Image src attribute to the file</li>\n<li>in the onload function,<ul>\n<li>draw the image onto the canvas</li>\n<li>call canvas.toDataUrl(mimeType) to get the data url.</li>\n</ul>\n</li>\n</ul>\n<p>It is pretty trivial code: </p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> canvas = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;canvas&quot;</span>);</span><br><span class=\"line\">context = canvas.<span class=\"title function_\">getContext</span>(<span class=\"string\">&#x27;2d&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> base_image = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">base_image.<span class=\"property\">src</span> = <span class=\"string\">&#x27;img/base.png&#x27;</span>;</span><br><span class=\"line\">base_image.<span class=\"property\">onload</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">  context.<span class=\"title function_\">drawImage</span>(base_image, <span class=\"number\">100</span>, <span class=\"number\">100</span>);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> dataUrl = canvas.<span class=\"title function_\">toDataURL</span>(<span class=\"string\">&#x27;image/jpeg&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>But, the trouble starts when you use a URL that doesn’t originate from the file system, or the same domain as the application your are running. </p>\n<p>The trick is to read the image using an XMLHttpRequest for foriegn URLs and then use a FileReader object and call readAsDataURL passing the result of the XMLHttpRequest.read. </p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> image = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\"><span class=\"keyword\">const</span> self = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> reader = <span class=\"keyword\">new</span> <span class=\"title class_\">FileReader</span>();</span><br><span class=\"line\">reader.<span class=\"property\">onloadend</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    reader.<span class=\"property\">onloadend</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// make sure the image is loaded before we go</span></span><br><span class=\"line\">    <span class=\"comment\">// after width and height;</span></span><br><span class=\"line\">    image.<span class=\"property\">src</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    image.<span class=\"property\">onload</span> = <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        image.<span class=\"property\">onload</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// do something with the new image here</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    image.<span class=\"property\">src</span> = reader.<span class=\"property\">result</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">image.<span class=\"property\">onload</span> = <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    image.<span class=\"property\">onload</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> xhr = <span class=\"keyword\">new</span> <span class=\"title class_\">XMLHttpRequest</span>();</span><br><span class=\"line\">    xhr.<span class=\"property\">onload</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        reader.<span class=\"title function_\">readAsDataURL</span>(xhr.<span class=\"property\">response</span>);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    xhr.<span class=\"title function_\">open</span>(<span class=\"string\">&#x27;GET&#x27;</span>, image.<span class=\"property\">src</span>);</span><br><span class=\"line\">    xhr.<span class=\"property\">responseType</span> = <span class=\"string\">&#x27;blob&#x27;</span>;</span><br><span class=\"line\">    xhr.<span class=\"title function_\">send</span>();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(action.<span class=\"property\">payload</span> <span class=\"keyword\">instanceof</span> <span class=\"title class_\">File</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// won&#x27;t be using image.onload so we need to turn it off</span></span><br><span class=\"line\">    image.<span class=\"property\">onload</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    reader.<span class=\"title function_\">readAsDataURL</span>(action.<span class=\"property\">payload</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// this triggers image.onload which triggers reader.readAsDataURL</span></span><br><span class=\"line\">    image.<span class=\"property\">src</span> = action.<span class=\"property\">payload</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now we can put the image using the data URL on the canvas and the canvas doesn’t know we got it from a foreign URL any more so we no longer get a cross origin URL. </p>\n<p>The entry point for this code is on line 27.  You see  that if we are working with a File, we just use the FileReader directly.  But if we are using http, we go through the XMLHttpRequest.</p>\n<h2 id=\"Fake-File-Upload\"><a href=\"#Fake-File-Upload\" class=\"headerlink\" title=\"Fake File Upload\"></a>Fake File Upload</h2><p>The only problem with this is that now we no longer have the file point, so if we want to upload the file, as a file, to the server we have come up with some way of creating a fake file object.  And believe it or not, that is a lot easier than you might think. </p>\n<p>You see, a File object is just a kind of Blob object.  So, all we really need to do is to create a Blob.  But, we have one additional issue.  Our image is in base 64 and we need to convert it to a binary byte array. </p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">b64toFile</span>(dataURI): <span class=\"title class_\">File</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// convert the data URL to a byte string</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> byteString = <span class=\"title function_\">atob</span>(dataURI.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;,&#x27;</span>)[<span class=\"number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// pull out the mime type from the data URL</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> mimeString = dataURI.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;,&#x27;</span>)[<span class=\"number\">0</span>].<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;:&#x27;</span>)[<span class=\"number\">1</span>].<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;;&#x27;</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Convert to byte array</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> ab = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayBuffer</span>(byteString.<span class=\"property\">length</span>);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> ia = <span class=\"keyword\">new</span> <span class=\"title class_\">Uint8Array</span>(ab);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; byteString.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">        ia[i] = byteString.<span class=\"title function_\">charCodeAt</span>(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Create a blob that looks like a file.</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> blob = <span class=\"keyword\">new</span> <span class=\"title class_\">Blob</span>([ab], &#123; <span class=\"string\">&#x27;type&#x27;</span>: mimeString &#125;);</span><br><span class=\"line\">    blob[<span class=\"string\">&#x27;lastModifiedDate&#x27;</span>] = (<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">toISOString</span>();</span><br><span class=\"line\">    blob[<span class=\"string\">&#x27;name&#x27;</span>] = <span class=\"string\">&#x27;file&#x27;</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">// Figure out what extension the file should have</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(blob.<span class=\"property\">type</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">&#x27;image/jpeg&#x27;</span>:</span><br><span class=\"line\">            blob[<span class=\"string\">&#x27;name&#x27;</span>] += <span class=\"string\">&#x27;.jpg&#x27;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">&#x27;image/png&#x27;</span>:</span><br><span class=\"line\">            blob[<span class=\"string\">&#x27;name&#x27;</span>] += <span class=\"string\">&#x27;.png&#x27;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// cast to a File</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &lt;<span class=\"title class_\">File</span>&gt;blob;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>You can use the resulting “File” anywhere you would use a File you had retrieved from the file system.</p>\n<h2 id=\"Upload-via-Http\"><a href=\"#Upload-via-Http\" class=\"headerlink\" title=\"Upload via Http\"></a>Upload via Http</h2><p>The last bit of this is that we need to upload this via the Http service.  This is going to be harder to show with code because it depends on what you need to do. </p>\n<p>In my case, I needed to just upload the file, so the post was pretty straight forward.  I used an Http.post() and passed the returned “file” as the data parameter. </p>\n<p>But, you may need to upload it by wrapping the file in a Form object and specifying varying headers.</p>\n<h2 id=\"The-End\"><a href=\"#The-End\" class=\"headerlink\" title=\"The End\"></a>The End</h2><p>I know it is a relatively short post, but I hope it is helpful to someone.  There are a lot of examples out there of how to do this in JavaScript and jQuery, but I was unable to find anything that was specific to TypeScript and Angular.</p>\n",
            "tags": [
                "angular",
                "images",
                "file upload"
            ]
        }
    ]
}