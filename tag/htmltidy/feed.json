{
    "version": "https://jsonfeed.org/version/1",
    "title": "Dave's Notebook • All posts by \"htmltidy\" tag",
    "description": null,
    "home_page_url": "http://davembush.github.com",
    "items": [
        {
            "id": "http://davembush.github.com/itextsharp-%E2%80%93-html-to-pdf-%E2%80%93-cleaning-html/",
            "url": "http://davembush.github.com/itextsharp-%E2%80%93-html-to-pdf-%E2%80%93-cleaning-html/",
            "title": "iTextSharp – HTML to PDF – Cleaning HTML",
            "date_published": "2009-07-20T10:23:07.000Z",
            "content_html": "<p><img src=\"/uploads/2009/07/H05K0013.jpg\" alt=\"H05K0013\" title=\"H05K0013\"> The last prerequisite step prior to actually converting our HTML into PDF code is to clean up the HTML. The method I use takes advantage of the XML parser in .NET but in order to use that we have to have XHTML compliant XML. For this exercise, what I am most concerned about is that the HTML tags all have matching closing tags, that the tags are nested in a hierarchical structure, and that the tags all are lower case. Some of this we will have to rely on the user to provide, like properly nesting the tags.  But some of this we can attempt to clean up in our code.  If you know you will have complete control over your HTML, you might be able to skip this step.  But I think the code is simple enough that you’ll want to add it anyhow.  In my code, I have a function that accepts the HTML string and returns a collection of IElements that my main code will insert into the PDF.  The first thing I do in that function is make sure the code starts and ends with an open and close paragraph tag.  This is to ensure that I have at least one element that I can work with when I do the translation.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!xhtmlString.ToLower().StartsWith(<span class=\"string\">&quot;&lt;p&gt;&quot;</span>))</span><br><span class=\"line\">    xhtmlString = <span class=\"string\">&quot;&lt;p&gt;&quot;</span> + xhtmlString + <span class=\"string\">&quot;&lt;/p&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>The next thing I do is make sure that all of the white space that isn’t the space character is removed from the code.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xhtmlString = xhtmlString</span><br><span class=\"line\">    .Replace(<span class=\"string\">&quot;\\</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span>, <span class=\"built_in\">string</span>.Empty)</span><br><span class=\"line\">    .Replace(<span class=\"string\">&quot;\\n&quot;</span>, <span class=\"built_in\">string</span>.Empty)</span><br><span class=\"line\">    .Replace(<span class=\"string\">&quot;\\t&quot;</span>, <span class=\"built_in\">string</span>.Empty);</span><br></pre></td></tr></table></figure>\n\n<p>Then we want to change our BR tags to auto close.  Since I don’t deal with IMG tags in this code I don’t bother auto closing those tags.  If you decide to embellish this code to use the IMG tag, you’ll want to add code to fix that as well.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xhtmlString = xhtmlString</span><br><span class=\"line\">    .Replace(<span class=\"string\">&quot;&lt;BR&gt;&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt;&quot;</span>)</span><br><span class=\"line\">    .Replace(<span class=\"string\">&quot;&lt;br&gt;&quot;</span>, <span class=\"string\">&quot;&lt;br /&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>Since my code currently ignores any attributes in the SPAN tag, I then remove the span tag’s attributes.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">System.Text.RegularExpressions.Regex re = <span class=\"literal\">null</span>;</span><br><span class=\"line\">System.Text.RegularExpressions.Match match = <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">re = <span class=\"keyword\">new</span> System.Text.RegularExpressions.Regex(<span class=\"string\">&quot;&lt;span.*?&gt;&quot;</span>);</span><br><span class=\"line\">match = re.Match(xhtmlString);</span><br><span class=\"line\"><span class=\"keyword\">while</span> (match.Success)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> (System.Text.RegularExpressions.Capture c <span class=\"keyword\">in</span> match.Captures)</span><br><span class=\"line\">        xhtmlString = xhtmlString.Replace(c.Value, <span class=\"built_in\">string</span>.Empty);</span><br><span class=\"line\">    match = match.NextMatch();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Then I force all my tags to lower case</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">re = <span class=\"keyword\">new</span> System.Text.RegularExpressions.Regex(<span class=\"string\">&quot;&lt;\\\\\\w+?&quot;</span>);</span><br><span class=\"line\">match = re.Match(xhtmlString);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> (match.Success)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> (System.Text.RegularExpressions.Capture c <span class=\"keyword\">in</span> match.Captures)</span><br><span class=\"line\">        xhtmlString = xhtmlString.Replace(c.Value, c.Value.ToLower());</span><br><span class=\"line\">    match = match.NextMatch();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">re = <span class=\"keyword\">new</span> System.Text.RegularExpressions.Regex(<span class=\"string\">&quot;&lt;/\\\\w+?&gt;&quot;</span>);</span><br><span class=\"line\">match = re.Match(xhtmlString);</span><br><span class=\"line\"><span class=\"keyword\">while</span> (match.Success)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> (System.Text.RegularExpressions.Capture c <span class=\"keyword\">in</span> match.Captures)</span><br><span class=\"line\">        xhtmlString = xhtmlString.Replace(c.Value, c.Value.ToLower());</span><br><span class=\"line\">    match = match.NextMatch();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Because the PDF code will treat each white space character as a character and HTML treats a string of white space characters as one space, I strip out any extra white space characters.  </p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> (xhtmlString.Contains(<span class=\"string\">&quot;&gt; &quot;</span>))</span><br><span class=\"line\">    xhtmlString = xhtmlString.Replace(<span class=\"string\">&quot;&gt; &quot;</span>, <span class=\"string\">&quot;&gt;&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">while</span> (xhtmlString.Contains(<span class=\"string\">&quot;  &quot;</span>))</span><br><span class=\"line\">    xhtmlString = xhtmlString.Replace(<span class=\"string\">&quot;  &quot;</span>, <span class=\"string\">&quot; &quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>And then I convert any special HTML strings to their text equivalent.  Right now, I only have to deal with the ampersand character.</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xhtmlString = xhtmlString.Replace(<span class=\"string\">&quot; &amp; &quot;</span>, <span class=\"string\">&quot; &amp;amp; &quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>Lastly, in order to ensure that my html string gets parsed correctly, I attempt to quote all my attributes</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">int</span> length = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (length != xhtmlString.Length)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    length = xhtmlString.Length;</span><br><span class=\"line\">    xhtmlString = System.Text</span><br><span class=\"line\">        .RegularExpressions.Regex .Replace(xhtmlString,</span><br><span class=\"line\">        <span class=\"string\">&quot;(&lt;.+?\\\\s+\\\\w+=)(\\[^\\&quot;&#x27;\\]\\\\S*?)(\\[\\\\s&gt;\\])&quot;</span>, <span class=\"string\">&quot;$1\\&quot;$2\\&quot;$3&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>With the exception of some features I’ve already noted that you might want to add, we’ve done all we can to clear up the code.  Any other problems are user input errors that will need to be corrected manually. Next, we can parse this HTML and convert it into PDF IElements. This process of cleaning up the HTML would all be a lot easier if HTML Tidy were converted to a managed code library.  (Yes, I know you can run it from .NET, but so far it is an external EXE, not managed code.)</p>\n",
            "tags": [
                "c#",
                "html",
                "iTextSharp",
                "PDF",
                "htmltidy"
            ]
        }
    ]
}